// Map
const map = L.map('map').setView([27.7090, 85.3240], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let otpCode;
let otpVerified = false;
let pickupMarker, dropMarker;
let selectedVehicle = "bike";
let fareAmount = 0;

// --- OTP ---
document.getElementById("sendOTP").onclick = () => {
  const phone = document.getElementById("phone").value;
  if (!phone) return alert("Enter phone number");

  otpCode = Math.floor(1000 + Math.random() * 9000);
  alert("Your OTP: " + otpCode);

  document.getElementById("otpInput").disabled = false;
  document.getElementById("verifyOTP").disabled = false;
};

document.getElementById("verifyOTP").onclick = () => {
  if (document.getElementById("otpInput").value == otpCode) {
    otpVerified = true;
    alert("OTP Verified!");
    enablePickupDrop();
  } else alert("Incorrect OTP");
};

function enablePickupDrop() {
  document.getElementById("pickupSearch").disabled = false;
  document.getElementById("pickupBtn").disabled = false;
  document.getElementById("dropSearch").disabled = false;
  document.getElementById("dropBtn").disabled = false;
}

// --- Vehicle Selection ---
document.querySelectorAll(".vehicle").forEach(v => {
  v.onclick = () => {
    document.querySelectorAll(".vehicle").forEach(x => x.classList.remove("active"));
    v.classList.add("active");
    selectedVehicle = v.dataset.type;
    document.getElementById("selectedVehicle").innerText = selectedVehicle;
    updateFare();
  };
});

// --- Search Location ---
async function searchLocation(text) {
  const res = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${text}`
  );
  const data = await res.json();
  if (data.length > 0)
    return { lat: data[0].lat, lng: data[0].lon };
  return null;
}

document.getElementById("pickupBtn").onclick = async () => {
  const loc = await searchLocation(document.getElementById("pickupSearch").value);
  if (!loc) return alert("Pickup not found");

  if (pickupMarker) pickupMarker.setLatLng(loc);
  else pickupMarker = L.marker(loc).addTo(map).bindPopup("Pickup");

  map.setView(loc, 14);
  updateFare();
};

document.getElementById("dropBtn").onclick = async () => {
  const loc = await searchLocation(document.getElementById("dropSearch").value);
  if (!loc) return alert("Drop not found");

  if (dropMarker) dropMarker.setLatLng(loc);
  else dropMarker = L.marker(loc).addTo(map).bindPopup("Drop");

  map.setView(loc, 14);
  updateFare();
};

// --- Fare Calculation ---
function haversine(a, b) {
  const R = 6371;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLon = (b.lng - a.lng) * Math.PI / 180;

  const lat1 = a.lat * Math.PI / 180;
  const lat2 = b.lat * Math.PI / 180;

  const h =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;

  return R * 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
}

function updateFare() {
  if (!pickupMarker || !dropMarker) return;

  const dist = haversine(pickupMarker.getLatLng(), dropMarker.getLatLng());
  const pricing = {
    bike: { base: 30, per_km: 10 },
    car: { base: 60, per_km: 25 },
    luxury: { base: 100, per_km: 50 },
    van: { base: 80, per_km: 35 }
  };

  let fare = pricing[selectedVehicle].base + pricing[selectedVehicle].per_km * dist;

  if (document.getElementById("promoCode").value.toLowerCase() === "discount10")
    fare *= 0.9;

  fareAmount = fare;
  document.getElementById("fare").innerText = "Fare: NPR " + fare.toFixed(0);
}

// --- Chat ---
document.getElementById("sendChat").onclick = () => {
  const msg = document.getElementById("chatInput").value;
  if (!msg) return;

  const box = document.getElementById("chatBox");
  box.innerHTML += `<p><b>You:</b> ${msg}</p>`;
  document.getElementById("chatInput").value = "";

  setTimeout(() => {
    box.innerHTML += `<p><b>Driver:</b> Ok</p>`;
  }, 1000);
};

// --- Feedback ---
document.getElementById("submitFeedback").onclick = () => {
  const fb = document.getElementById("feedbackInput").value;
  if (!fb) return alert("Write feedback");

  alert("Feedback Submitted!");
  document.getElementById("feedbackInput").value = "";
};
